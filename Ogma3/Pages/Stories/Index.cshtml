@page
@using System.Text.Json
@using Ogma3.Data.Enums
@using Ogma3.Api.V1
@model Ogma3.Pages.Stories.IndexModel

@{
    ViewData["Title"] = "Browse stories";
    ViewData["ActivePage"] = "Stories";
}

<partial name="_SubNavigation" />

<form id="search" class="search" method="GET" v-on:submit.prevent="submit($event)">
    
    <div class="inline title field">
        <label for="query">Title</label>
        <input class="active-border" 
               id="query" 
               name="q" 
               type="text" 
               v-on:input="els.query = $event.target.value"
               :disabled="dis.query"
               value="@Model.SearchBy">
    </div>
    
    <div class="inline rating field">
        <label for="rating">Rating</label>
        <select class="active-border"
                name="rating"
                v-on:input="els.rating = $event.target.value"
                :disabled="dis.rating"
                id="rating">
            <option value="">---</option>
            @foreach (var r in Model.Ratings)
            {
                <option selected="@(r.Id == Model.Rating)" value="@r.Id">@r.Name</option>
            }
        </select>
    </div>
    
    <div class="inline sort field">
        <label for="sort">Sort</label>
        <select class="active-border"
                name="sort"
                id="sort"
                v-on:input="els.sort = $event.target.value"
                :disabled="dis.sort"
                asp-for="SortBy"
                asp-items="Html.GetEnumSelectList<EStorySortingOptions>()">
        </select>
    </div>
    
    <div class="inline tags field">
        <tag-search-select label="Tags"
                           ref="tags"
                           inline
                           disable-when-empty
                           :preselected="@JsonSerializer.Serialize(Model.Tags)"
                           tags-api="@Url.RouteUrl(nameof(TagsController))">
        </tag-search-select>
    </div>
    
    <div class="inline submit field">
        <input class="inline active-border" type="submit" value="Search">
    </div>
</form>


<div>
    @if (Model.Stories.Count <= 0)
    {
        <h1>No stories found</h1>
    }
    else
    {
        foreach (var story in Model.Stories)
        {
            <partial name="Shared/_StoryCard" model="@story"/>
        }
        
        if (Model.StoriesCount > Model.PerPage)
        {
            <div class="pagination">
                <a class="prev button" href="?page=@(Math.Max(1, Model.PageNumber - 1))">Previous</a>
                @if (Model.PageNumber > 5)
                {
                    <div class="ph button">...</div>
                }
                @for (var i = 1; i <= (int)Math.Ceiling((double)Model.StoriesCount / Model.PerPage); i++)
                {
                    if (i >= Model.PageNumber - 4 && i <= Math.Max(Model.PageNumber, 5))
                    {
                        <a href="?page=@i"
                           class="page button @(i == Model.PageNumber ? "active" : "")">
                            @i
                        </a>
                    }
                }
                @if (Model.StoriesCount / Model.PerPage > 5 && Model.PageNumber != Model.StoriesCount / Model.PerPage)
                {
                    <div class="ph button">...</div>
                }
                <a class="next button" href="?page=@(Math.Min(Model.PageNumber + 1, (int)Math.Ceiling((double)Model.StoriesCount / Model.PerPage)))">Next</a>
            </div>
        }
    }
</div>

@section Scripts
{
    <script src="~/js/dist/vue-directives/closeable.min.js" asp-append-version="true"></script>
    <script src="~/js/dist/components/tag-search-select-component.min.js" asp-append-version="true"></script>
    <script src="~/js/dist/search/story.min.js" asp-append-version="true"></script>
}