@using static Ogma3.Services.HtmlExtensions
@using Ogma3.Api.V1
@inject OgmaConfig Config
@model long

<div class="comments-container" id="comments-container">

    @if (User.Identity != null && User.Identity.IsAuthenticated)
    {
        <form asp-antiforgery="true">
            <textarea class="comment-box active-border" 
                      v-model="body" 
                      v-on:keydown.enter="enter" 
                      name="body" id="body" 
                      rows="3" 
                      aria-label="Comment">
            </textarea>

            <div id="thread" data-thread="@Model" v-if="!thread"></div>
            <div id="route" data-route="@Url.RouteUrl(nameof(CommentsController))" v-if="!route"></div>
            <div id="per-page" data-count="@Config.CommentsPerPage" v-if="!perPage"></div>

            <div class="buttons">
                <button class="comment-btn active-border" v-on:click="submit">
                    <icon icon="add_comment"></icon>
                    Comment
                </button>
                <a class="help-btn active-border" target="_blank" asp-page="/Markdown" asp-area="">
                    <icon icon="help_outline"></icon>
                </a>
            </div>
        </form>
    }
    else
    {
        <span>
            <a asp-area="Identity" asp-page="/Account/Login">Log in</a> or 
            <a asp-area="Identity" asp-page="/Account/Register">register</a> 
            to be able to leave comments
        </span>
    }
    
    <br>
    
    <div class="pagination" v-if="comments && total > perPage">
        <button class="prev button" v-on:click="prevPage">Previous</button>
        <button class="ph button" v-if="page > 5">...</button>
        <button v-for="idx in Math.ceil(total / perPage)"
                :key="idx"
                v-on:click="changePage(idx)"
                :class="idx === page ? 'active' : ''"
                v-if="idx >= page - 4 && idx <= Math.max(page, 5)"
                class="page button">
            {{idx}}
        </button>
        <button class="ph button" v-if="total / perPage > 5 && page !== total / perPage">...</button>
        <button class="next button" v-on:click="nextPage">Next</button>
    </div>

    <div class="comments">
        
        <div :id="`comment-${c.key+1}`"
             class="comment" :class="c.key+1 === highlight ? 'marked' : ''"
             v-for="c in comments">
            
            <div v-if="c.val.author" class="author">
                
                <a :href="`/user/${c.val.author.userName}`" class="name">{{ c.val.author.userName }}</a>
                
                <div v-if="c.val.author.roles[0]" class="role-tag">
                    <span class="name">{{c.val.author.roles[0].name}}</span>
                    <div class="bg" :style="{backgroundColor: c.val.author.roles[0].color}"></div>
                </div>
                
                <img :src="`@Config.Cdn${c.val.author.avatar}`" :alt="c.val.author.userName + '\'s avatar'" class="avatar">
                
            </div>
            
            <div class="main">
                
                <div class="header">

                    <a class="link"
                       v-if="c.val.author"
                       :href="`#comment.${c.key+1}`"
                       v-on:click="changeHighlight(c.key+1, $event)">
                        #{{ c.key+1 }}
                    </a>

                    <p v-if="c.val.author" class="sm-line"></p>

                    <time :datetime="c.val.dateTime" class="time">{{ date(c.val.dateTime) }}</time>
                    
                    <p v-if="!c.val.author" class="sm-line"></p>
                    
                    <span v-if="c.val.deletedBy">Comment deleted by {{ c.val.deletedBy.toLowerCase() }}.</span>
                    
                    <div v-if="c.val.owned" class="actions">
                        <button class="action-btn small" v-on:click="del(c.val.id)">
                            <icon class="icon" icon="delete_forever"></icon>
                        </button>
                        <button class="action-btn small" v-on:click="edit(c.val.id)">
                            <icon class="icon" icon="edit"></icon>
                        </button>
                    </div>
                    
                </div>

                <div v-if="c.val.body && (!editData || editData.id !== c.val.id)" class="body" v-html="c.val.body"></div>
                
                <form class="form" v-if="editData && editData.id === c.val.id" asp-antiforgery="true">
                    <textarea class="comment-box" 
                              v-model="editData.body" 
                              v-on:keydown.enter="enter" 
                              name="body" id="edit-body" 
                              rows="3" 
                              aria-label="Comment">
                    </textarea>
        
                    <div class="buttons">
                        <button class="confirm active-border" v-on:click="update">
                            <icon icon="edit"></icon>
                            Update
                        </button>
                        <button class="cancel active-border" v-on:click="editData = null">
                            <icon icon="cancel"></icon>
                            Cancel
                        </button>
                    </div>
                </form>
                
                <span v-if="c.val.lastEdit" class="edit-data">
                    Edited <span class="count" v-on:click="history(c.val.id)">{{c.val.editCount}} times</span>, last edit: <time :datetime="c.val.lastEdit" >{{ date(c.val.lastEdit) }}</time>
                </span>
                
            </div>
            
        </div>
    </div>
    
    <div class="pagination" v-if="comments && total > perPage">
        <button class="prev button" v-on:click="prevPage">Previous</button>
        <button class="ph button" v-if="page > 5">...</button>
        <button v-for="idx in Math.ceil(total / perPage)"
                :key="idx"
                v-on:click="changePage(idx)"
                :class="idx === page ? 'active' : ''"
                v-if="idx >= page - 4 && idx <= Math.max(page, 5)"
                class="page button">
            {{idx}}
        </button>
        <button class="ph button" v-if="total / perPage > 5 && page !== total / perPage">...</button>
        <button class="next button" v-on:click="nextPage">Next</button>
    </div>

</div>

@Html.Resource(@<script src="~/js/dist/comments.min.js" asp-append-version="true"></script>)