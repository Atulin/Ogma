@using static Ogma3.Services.HtmlExtensions
@using Ogma3.Api
@using Ogma3.Api.V1
@model Ogma3.Data.Models.CommentsThread

<div class="comments-container" id="comments-container">

    @if (User.Identity.IsAuthenticated)
    {
        <form asp-antiforgery="true">
            <textarea class="comment-box active-border" 
                      v-model="body" 
                      v-on:keydown.enter="enter" 
                      name="body" id="body" 
                      rows="3" 
                      aria-label="Comment">
            </textarea>

            <div id="thread" data-thread="@Model.Id" v-if="!thread"></div>
            <div id="route" data-route="@Url.RouteUrl(nameof(CommentsController))" v-if="!route"></div>

            <div class="buttons">
                <button class="comment-btn active-border" v-on:click="submit">
                    <icon icon="add_comment"></icon>
                    Comment
                </button>
                <a class="help-btn active-border" target="_blank" asp-page="/Markdown" asp-area="">
                    <icon icon="help_outline"></icon>
                </a>
            </div>
        </form>
    }
    else
    {
        <span>
            <a asp-area="Identity" asp-page="/Account/Login">Log in</a> or 
            <a asp-area="Identity" asp-page="/Account/Register">register</a> 
            to be able to leave comments
        </span>
    }

    <div class="comments">
        <div :id="`comment-${c.key+1}`" 
             class="comment" :class="c.key+1 === highlight ? 'marked' : ''"
             v-for="c in visibleComments">
            <div class="author">
                <span class="name">{{ c.val.author.userName }}</span>
                <img :src="c.val.author.avatar" :alt="c.val.author.userName + '\'s avatar'" class="avatar">
            </div>
            <div class="main">
                <div class="header">
                    <a class="link"
                        :href="`#comment.${c.key+1}`"
                        v-on:click="changeHighlight(c.key+1, $event)">
                        #{{ c.key+1 }}
                    </a>
                    <p class="sm-line"></p>
                    <time :datetime="c.val.dateTime" class="time">{{ date(c.val.dateTime) }}</time>
                </div>
                <div class="body" v-html="c.val.body"></div>
            </div>
        </div>
    </div>
    
    <div class="pagination" v-if="comments && comments.length > perPage">
        <button class="prev button" v-on:click="prevPage">Previous</button>
        <button class="ph button" v-if="page > 5">...</button>
        <button v-for="idx in Math.ceil(comments.length / perPage)"
                :key="idx"
                v-on:click="changePage(idx)"
                :class="idx === page ? 'active' : ''"
                v-if="idx >= page - 4 && idx <= Math.max(page, 5)"
                class="page button">
            {{idx}}
        </button>
        <button class="ph button" v-if="comments.length / perPage > 5 && page !== comments.length / perPage">...</button>
        <button class="next button" v-on:click="nextPage">Next</button>
    </div>

</div>

@Html.Resource(@<script src="~/js/dist/comments.min.js" asp-append-version="true"></script>)